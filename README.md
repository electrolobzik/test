function () { var doc = this.firebaseAdapter_.getDocument(); var html = '', newLine = true; html += Firepad.EXPORT_HTML_STYLE; function open(listType) { return (listType === LIST_TYPE.ORDERED) ? '
' : (listType === LIST_TYPE.UNORDERED) ? '
' : '
'; } function close(listType) { return (listType === LIST_TYPE.ORDERED) ? '
' : ''; } var listTypeStack = []; var inListItem = false; var firstLine = true; var emptyLine = true; var i = 0, op = doc.ops[i]; var usesTodo = false; while(op) { utils.assert(op.isInsert()); var attrs = op.attributes; if (newLine) { newLine = false; var indent = 0, listType = null, lineAlign = 'left'; if (ATTR.LINE_SENTINEL in attrs) { indent = attrs[ATTR.LINE_INDENT] || 0; listType = attrs[ATTR.LIST_TYPE] || null; lineAlign = attrs[ATTR.LINE_ALIGN] || 'left'; } if (listType) { indent = indent || 1; // lists are automatically indented at least 1. } if (inListItem) { html += ''; inListItem = false; } else if (!firstLine) { if (emptyLine) { html += '
'; } html += ''; } firstLine = false; // Close any extra lists. function compatibleListType(l1, l2) { return (l1 === l2) || (l1 === LIST_TYPE.TODO && l2 === LIST_TYPE.TODOCHECKED) || (l1 === LIST_TYPE.TODOCHECKED && l2 === LIST_TYPE.TODO); } utils.assert(indent >= 0, "Indent must not be negative."); while (listTypeStack.length > indent || (indent === listTypeStack.length && listType !== null && !compatibleListType(listType, listTypeStack[listTypeStack.length - 1]))) { html += close(listTypeStack.pop()); } // Open any needed lists. while (listTypeStack.length < indent) { var toOpen = listType || LIST_TYPE.UNORDERED; // default to unordered lists for indenting non-list-item lines. usesTodo = listType == LIST_TYPE.TODO || listType == LIST_TYPE.TODOCHECKED || usesTodo; html += open(toOpen); listTypeStack.push(toOpen); } var style = (lineAlign !== 'left') ? ' style="text-align:' + lineAlign + '"': ''; if (listType) { var clazz = ''; switch (listType) { case LIST_TYPE.TODOCHECKED: clazz = ' class="firepad-checked"'; break; case LIST_TYPE.TODO: clazz = ' class="firepad-unchecked"'; break; } html += ""; inListItem = true; } else { // start line div. html += ''; } emptyLine = true; } if (ATTR.LINE_SENTINEL in attrs) { op = doc.ops[++i]; continue; } if (ATTR.ENTITY_SENTINEL in attrs) { for(var j = 0; j < op.text.length; j++) { var entity = firepad.Entity.fromAttributes(attrs); var element = this.entityManager_.exportToElement(entity); html += element.outerHTML; } op = doc.ops[++i]; continue; } var prefix = '', suffix = ''; for(var attr in attrs) { var value = attrs[attr]; var start, end; if (attr === ATTR.BOLD || attr === ATTR.ITALIC || attr === ATTR.UNDERLINE || attr === ATTR.STRIKE) { utils.assert(value === true); start = end = attr; } else if (attr === ATTR.FONT_SIZE) { start = 'span style="font-size: ' + value; start += (typeof value !== "string" || value.indexOf("px", value.length - 2) === -1) ? 'px"' : '"'; end = 'span'; } else if (attr === ATTR.FONT) { start = 'span style="font-family: ' + value + '"'; end = 'span'; } else if (attr === ATTR.COLOR) { start = 'span style="color: ' + value + '"'; end = 'span'; } else { utils.log(false, "Encountered unknown attribute while rendering html: " + attr); } if (start) prefix += '<' + start + '>'; if (end) suffix = '' + suffix; } var text = op.text; var newLineIndex = text.indexOf('\n'); if (newLineIndex >= 0) { newLine = true; if (newLineIndex < text.length - 1) { // split op. op = new firepad.TextOp('insert', text.substr(newLineIndex+1), attrs); } else { op = doc.ops[++i]; } text = text.substr(0, newLineIndex); } else { op = doc.ops[++i]; } // Replace leading, trailing, and consecutive spaces with nbsp's to make sure they're preserved. text = text.replace(/ +/g, function(str) { return new Array(str.length + 1).join('\u00a0'); }).replace(/^ /, '\u00a0').replace(/ $/, '\u00a0'); if (text.length > 0) { emptyLine = false; } html += prefix + this.textToHtml_(text) + suffix; } if (inListItem) { html += ''; } else if (!firstLine) { if (emptyLine) { html += ' '; } html += ''; } // Close any extra lists. while (listTypeStack.length > 0) { html += close(listTypeStack.pop()); } if (usesTodo) { html = Firepad.TODO_STYLE + html; } return html; }this is the test
this is the test
